name: Deploy Database to Supabase (Simple)

on:
  push:
    branches:
      - main
    paths:
      - 'schema.sql'
      - 'schema_enhancements.sql'
      - 'sample_data.sql'
      - 'sample_data_enhancements.sql'
  workflow_dispatch: # Allow manual triggering
    inputs:
      include_sample_data:
        description: 'Include sample data?'
        required: false
        default: 'true'
        type: boolean

jobs:
  deploy-database:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Deploy Database Schema
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "Deploying database schema to Supabase..."
          
          # Deploy base schema (ignore errors for existing objects)
          if [ -f "schema.sql" ]; then
            echo "Running schema.sql..."
            psql "${SUPABASE_DB_URL}" -f schema.sql 2>&1 | grep -v "already exists" || true
            echo "✓ Base schema deployment completed"
          fi
          
          # Deploy enhancements (ignore errors for existing objects)
          if [ -f "schema_enhancements.sql" ]; then
            echo "Running schema_enhancements.sql..."
            psql "${SUPABASE_DB_URL}" -f schema_enhancements.sql 2>&1 | grep -v "already exists" || true
            echo "✓ Schema enhancements deployment completed"
          fi
          
          echo "✓ Database schema deployment completed!"
      
      - name: Deploy Sample Data
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.include_sample_data == 'true' || github.event.inputs.include_sample_data == null) || github.event_name == 'push' }}
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "Deploying sample data..."
          
          # Deploy base sample data (ignore duplicate key errors)
          if [ -f "sample_data.sql" ]; then
            echo "Running sample_data.sql..."
            psql "${SUPABASE_DB_URL}" -f sample_data.sql 2>&1 | grep -v "duplicate key\|already exists" || true
            echo "✓ Base sample data deployment completed"
          fi
          
          # Deploy enhanced sample data (ignore duplicate key errors)
          if [ -f "sample_data_enhancements.sql" ]; then
            echo "Running sample_data_enhancements.sql..."
            psql "${SUPABASE_DB_URL}" -f sample_data_enhancements.sql 2>&1 | grep -v "duplicate key\|already exists" || true
            echo "✓ Enhanced sample data deployment completed"
          fi
          
          echo "✓ Sample data deployment completed!"
      
      - name: Verify Tables
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "Verifying database tables..."
          
          TABLE_LIST=$(psql "${SUPABASE_DB_URL}" -t -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE' ORDER BY table_name;")
          
          echo "Tables in database:"
          echo "$TABLE_LIST"
          
          TABLE_COUNT=$(psql "${SUPABASE_DB_URL}" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';")
          
          echo "Total tables: $TABLE_COUNT"
          
          if [ "$TABLE_COUNT" -lt 15 ]; then
            echo "Warning: Expected at least 15 tables. Current count: $TABLE_COUNT"
          else
            echo "✓ Database verification successful!"
          fi

