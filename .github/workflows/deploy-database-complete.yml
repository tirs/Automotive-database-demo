name: Deploy Complete Database (Schema + Data)

on:
  workflow_dispatch: # Manual trigger only
    inputs:
      deploy_schema:
        description: 'Deploy schema files?'
        required: true
        default: 'true'
        type: boolean
      deploy_sample_data:
        description: 'Deploy sample data files?'
        required: true
        default: 'true'
        type: boolean

jobs:
  deploy-database:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Deploy Database Schema
        if: ${{ github.event.inputs.deploy_schema == 'true' }}
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "Deploying database schema to Supabase..."
          
          # Deploy base schema (ignore errors for existing objects)
          if [ -f "schema.sql" ]; then
            echo "Running schema.sql..."
            psql "${SUPABASE_DB_URL}" -f schema.sql 2>&1 | grep -v "already exists" || true
            echo "✓ Base schema deployment completed"
          fi
          
          # Deploy enhancements (ignore errors for existing objects)
          if [ -f "schema_enhancements.sql" ]; then
            echo "Running schema_enhancements.sql..."
            psql "${SUPABASE_DB_URL}" -f schema_enhancements.sql 2>&1 | grep -v "already exists" || true
            echo "✓ Schema enhancements deployment completed"
          fi
          
          echo "✓ Database schema deployment completed!"
      
      - name: Deploy Sample Data
        if: ${{ github.event.inputs.deploy_sample_data == 'true' }}
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "Deploying sample data..."
          
          # Deploy base sample data (ignore duplicate key errors)
          if [ -f "sample_data.sql" ]; then
            echo "Running sample_data.sql..."
            psql "${SUPABASE_DB_URL}" -f sample_data.sql 2>&1 | grep -v "duplicate key\|already exists" || true
            echo "✓ Base sample data deployment completed"
          fi
          
          # Deploy enhanced sample data (ignore duplicate key errors)
          if [ -f "sample_data_enhancements.sql" ]; then
            echo "Running sample_data_enhancements.sql..."
            psql "${SUPABASE_DB_URL}" -f sample_data_enhancements.sql 2>&1 | grep -v "duplicate key\|already exists" || true
            echo "✓ Enhanced sample data deployment completed"
          fi
          
          echo "✓ Sample data deployment completed!"
      
      - name: Verify Deployment
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          echo "Verifying database deployment..."
          
          # Count tables
          TABLE_COUNT=$(psql "${SUPABASE_DB_URL}" -t -A -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';")
          
          echo "Total tables created: $TABLE_COUNT"
          
          # List all tables
          echo ""
          echo "Tables in database:"
          psql "${SUPABASE_DB_URL}" -t -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE' ORDER BY table_name;"
          
          # Count records in key tables
          echo ""
          echo "Record counts:"
          psql "${SUPABASE_DB_URL}" -t -c "
            SELECT 'vehicle' as table_name, COUNT(*) as count FROM vehicle
            UNION ALL
            SELECT 'owner', COUNT(*) FROM owner
            UNION ALL
            SELECT 'service_record', COUNT(*) FROM service_record
            UNION ALL
            SELECT 'warranty', COUNT(*) FROM warranty
            UNION ALL
            SELECT 'accident', COUNT(*) FROM accident
            ORDER BY table_name;
          " || echo "Note: Some tables may not have data yet"
          
          if [ "$TABLE_COUNT" -ge 15 ]; then
            echo ""
            echo "✓ Database deployment verified successfully!"
            echo "Expected tables: 19 (9 base + 10 enhancements)"
            echo "Found tables: $TABLE_COUNT"
          else
            echo ""
            echo "⚠ Warning: Expected at least 15 tables, found $TABLE_COUNT"
            echo "Some tables may not have been created. Check the logs above."
          fi

